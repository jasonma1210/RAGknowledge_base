# 向量存储实现分析

## 1. 整体架构

项目使用 Milvus 作为向量数据库，通过 LangChain4j 框架集成 MilvusEmbeddingStore 来管理向量数据。系统为每个用户创建独立的 collection，实现数据隔离。

## 2. 存储实现思路

### 2.1 数据预处理
1. 文档上传后，通过 `DocumentProcessor` 进行内容提取和文本分块
2. 使用 `EmbeddingService` 将文本块转换为向量嵌入

### 2.2 向量存储流程
1. 为每个用户创建独立的 Milvus collection（命名规则：`用户名_用户ID`）
2. 使用 `MilvusEmbeddingStore` 存储向量和对应的文本片段
3. 在关系型数据库中保存文件记录与向量ID的映射关系
4. 支持元数据存储，包括文件ID、标题、文件类型、分块索引等

### 2.3 存储优化
1. 批量操作：向量存储和映射关系保存都采用批量处理方式
2. 异常处理：对存储过程中的异常进行捕获和记录，确保系统稳定性
3. 资源管理：及时关闭 Milvus 客户端连接

## 3. 检索实现思路

### 3.1 语义搜索
1. 将查询文本转换为向量嵌入
2. 使用 `MilvusEmbeddingStore` 的相似度搜索功能
3. 支持设置最大结果数和最小相似度阈值
4. 返回匹配结果并按相似度排序

### 3.2 关键词搜索
1. 通过 Milvus 的元数据过滤功能进行初步筛选
2. 在返回的结果中进行关键词匹配
3. 计算关键词匹配度分数
4. 按匹配度排序返回结果

### 3.3 混合搜索
1. 同时执行语义搜索和关键词搜索
2. 合并两种搜索结果并去重
3. 优先保留语义搜索结果
4. 按综合分数排序返回结果

## 4. 优化方法

### 4.1 性能优化
1. **用户隔离**：为每个用户创建独立的 collection，避免查询时的数据干扰
2. **批量处理**：向量存储和映射关系保存采用批量操作，提高效率
3. **连接管理**：合理管理 Milvus 客户端连接，及时关闭无用连接
4. **结果限制**：在关键词搜索中限制最大结果数量，避免性能问题

### 4.2 查询优化
1. **索引优化**：利用 Milvus 的向量索引能力加速相似度搜索
2. **过滤优化**：在搜索时使用元数据过滤减少搜索空间
3. **缓存策略**：可以考虑对热门查询结果进行缓存

### 4.3 存储优化
1. **数据压缩**：根据需要选择合适的向量维度，平衡精度和存储空间
2. **定期清理**：及时删除不需要的向量数据，释放存储空间
3. **备份策略**：建立定期备份机制，确保数据安全

## 5. 安全性考虑

1. **数据隔离**：通过用户专属 collection 实现数据隔离
2. **访问控制**：在应用层面对用户访问权限进行控制
3. **日志记录**：详细记录向量存储和检索操作，便于审计

## 6. 可扩展性

1. **水平扩展**：Milvus 支持分布式部署，可以水平扩展存储和计算能力
2. **模型替换**：通过 LangChain4j 框架可以方便地替换不同的嵌入模型
3. **存储引擎**：可以根据需要切换不同的向量数据库实现